name: "CodeQL Advanced Comprehensive Analysis"

on:
  push:
    branches: [ "main", "develop", "release/*" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    - cron: '34 8 * * 0'
  workflow_dispatch:

jobs:
  prepare:
    name: Prepare CodeQL Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Create CodeQL Config
        run: |
          mkdir -p .github/codeql/custom-queries
          
          # Create main config
          cat > .github/codeql/config.yml << 'EOL'
          name: "Enhanced CodeQL Config"
          
          paths:
            - 'src'
            - 'lib'
            - 'app'
            - 'core'
            - 'services'
            - 'api'
            
          paths-ignore:
            - '**/test/**'
            - '**/tests/**'
            - '**/spec/**'
            - '**/benchmark/**'
            - '**/node_modules/**'
            - '**/vendor/**'
            - '**/dist/**'
            - '**/build/**'
            - '**/*.test.*'
            - '**/*.spec.*'
            - '**/*.min.js'
            
          queries:
            - uses: security-extended
            - uses: security-and-quality
            - uses: ./.github/codeql/custom-queries/python
            - uses: ./.github/codeql/custom-queries/javascript
            
          query-filters:
            - exclude:
                id: js/redundant-assignment
            - exclude:
                id: py/redundant-assignment
            - exclude:
                tags: maintain
            - include:
                severity: error
            - include:
                severity: warning
                precision: high
          
          database:
            threads: auto
            ram: 8192
          EOL

          # Create custom Python queries
          mkdir -p .github/codeql/custom-queries/python
          cat > .github/codeql/custom-queries/python/custom-security.ql << 'EOL'
          /**
           * @name Custom Python Security Check
           * @description Identifies potential security issues in Python code
           * @kind problem
           * @problem.severity warning
           * @precision high
           * @id py/custom-security
           */
          import python

          from Call call, Value val
          where
            call.getFunc().toString() in ["eval", "exec", "pickle.loads"] and
            not call.getScope() instanceof Test
          select call, "Potentially unsafe function call detected"
          EOL

          # Create custom JavaScript queries
          mkdir -p .github/codeql/custom-queries/javascript
          cat > .github/codeql/custom-queries/javascript/custom-security.ql << 'EOL'
          /**
           * @name Custom JavaScript Security Check
           * @description Identifies potential security issues in JavaScript code
           * @kind problem
           * @problem.severity warning
           * @precision high
           * @id js/custom-security
           */
          import javascript

          from CallExpr call
          where
            call.getCalleeName() in ["eval", "Function", "setTimeout", "setInterval"] and
            exists(call.getArgument(0)) and
            call.getArgument(0).getType().toString() = "string"
          select call, "Potentially dangerous dynamic code execution"
          EOL

  analyze:
    name: Analyze (${{ matrix.language }})
    needs: prepare
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - language: 'python'
            build-mode: 'autodetect'
            python-version: '3.x'
          - language: 'javascript-typescript'
            build-mode: 'autodetect'
            node-version: '18'
          - language: 'java-kotlin'
            build-mode: 'autodetect'
            java-version: '17'
          - language: 'c-cpp'
            build-mode: 'autodetect'
          - language: 'go'
            build-mode: 'autodetect'
            go-version: '1.20'
          - language: 'ruby'
            build-mode: 'autodetect'
            ruby-version: '3.2'
          - language: 'swift'
            build-mode: 'autodetect'
            xcode-version: '14.2'
          - language: 'csharp'
            build-mode: 'autodetect'
            dotnet-version: '7.0'
          - language: 'php'
            build-mode: 'autodetect'
            php-version: '8.2'

    steps:
    # ... (previous setup steps remain the same)

    - name: Setup Go
      if: matrix.language == 'go'
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
        cache: true

    - name: Setup Ruby
      if: matrix.language == 'ruby'
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true

    - name: Setup Swift
      if: matrix.language == 'swift'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ matrix.xcode-version }}

    - name: Setup .NET
      if: matrix.language == 'csharp'
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ matrix.dotnet-version }}

    - name: Setup PHP
      if: matrix.language == 'php'
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        coverage: none

    - name: Generate Enhanced Report
      if: always()
      run: |
        echo "# CodeQL Analysis Report for ${{ matrix.language }}" > report.md
        echo "## Analysis Details" >> report.md
        echo "- **Language:** ${{ matrix.language }}" >> report.md
        echo "- **Timestamp:** $(date)" >> report.md
        echo "- **Build Mode:** ${{ matrix.build-mode }}" >> report.md
        
        if [ -d "sarif-results" ]; then
          echo "## Security Findings" >> report.md
          
          # Parse SARIF results
          if [ -f sarif-results/*.sarif ]; then
            echo "### Alerts by Severity" >> report.md
            HIGH=$(grep -c '"level": "error"' sarif-results/*.sarif || echo "0")
            MEDIUM=$(grep -c '"level": "warning"' sarif-results/*.sarif || echo "0")
            LOW=$(grep -c '"level": "note"' sarif-results/*.sarif || echo "0")
            
            echo "- 🔴 High: $HIGH" >> report.md
            echo "- 🟡 Medium: $MEDIUM" >> report.md
            echo "- 🟢 Low: $LOW" >> report.md
            
            echo "### Alert Categories" >> report.md
            echo "\`\`\`" >> report.md
            grep -ho '"name": "[^"]*"' sarif-results/*.sarif | sort | uniq -c | sort -nr >> report.md
            echo "\`\`\`" >> report.md
            
            echo "### Affected Files" >> report.md
            echo "\`\`\`" >> report.md
            grep -ho '"uri": "[^"]*"' sarif-results/*.sarif | sort | uniq -c | sort -nr | head -10 >> report.md
            echo "\`\`\`" >> report.md
          fi
        fi

    - name: Upload Enhanced Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: codeql-report-${{ matrix.language }}
        path: report.md
        retention-days: 30

  summary:
    name: Comprehensive Analysis Summary
    needs: analyze
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create Summary
        run: |
          echo "# CodeQL Analysis Summary" > summary.md
          echo "## Overview" >> summary.md
          echo "Analysis completed at: $(date)" >> summary.md
          echo "## Language Status" >> summary.md
          
          declare -A emoji
          emoji["success"]="✅"
          emoji["failure"]="❌"
          emoji["cancelled"]="⚠️"
          emoji["skipped"]="⏭️"
          
          for language in "python" "javascript-typescript" "java-kotlin" "c-cpp" "go" "ruby" "swift" "csharp" "php"; do
            status="${{ needs.analyze.result }}"
            echo "${emoji[$status]} $language: $status" >> summary.md
          done

      - name: Upload Summary
        uses: actions/upload-artifact@v3
        with:
          name: codeql-comprehensive-summary
          path: summary.md

          name: "CodeQL Advanced Security Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    - cron: '34 8 * * 0'
  workflow_dispatch:

jobs:
  prepare:
    name: Prepare CodeQL Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create CodeQL Config
        run: |
          mkdir -p .github/codeql
          cat > .github/codeql/config.yml << 'EOL'
          name: "CodeQL Config"
          
          paths:
            - 'src'
            - 'lib'
            - 'app'
            
          paths-ignore:
            - '**/test/**'
            - '**/tests/**'
            - '**/node_modules/**'
            - '**/vendor/**'
            - '**/*.test.js'
            - '**/*.spec.ts'
            
          queries:
            - uses: security-extended
            - uses: security-and-quality
          
          query-filters:
            - exclude:
                id: js/redundant-assignment
            - exclude:
                tags: maintain
                
          EOL

  analyze:
    name: Analyze (${{ matrix.language }})
    needs: prepare
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    timeout-minutes: 360
    
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: 'python'
            build-mode: 'autodetect'
          - language: 'javascript-typescript'
            build-mode: 'autodetect'
          - language: 'java-kotlin'
            build-mode: 'autodetect'
          - language: 'c-cpp'
            build-mode: 'autodetect'
          - language: 'go'
            build-mode: 'autodetect'
          - language: 'ruby'
            build-mode: 'autodetect'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Setup Python
      if: matrix.language == 'python'
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        cache: 'pip'

    - name: Setup Node.js
      if: matrix.language == 'javascript-typescript'
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Java
      if: matrix.language == 'java-kotlin'
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        queries: security-extended,security-and-quality
        config-file: ./.github/codeql/config.yml
        ram: 6144
        threads: auto

    - name: Build Python
      if: matrix.language == 'python'
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f setup.py ]; then pip install -e .; fi
        if [ -f pyproject.toml ]; then pip install -e .; fi

    - name: Build JavaScript/TypeScript
      if: matrix.language == 'javascript-typescript'
      run: |
        if [ -f package.json ]; then
          npm ci
          npm audit fix || true
          npm run build --if-present
        fi

    - name: Build Java/Kotlin
      if: matrix.language == 'java-kotlin'
      run: |
        if [ -f pom.xml ]; then
          mvn clean install -DskipTests
        elif [ -f build.gradle ]; then
          ./gradlew build -x test
        fi

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        upload: true
        output: sarif-results

    - name: Process Analysis Results
      if: always()
      run: |
        if [ -d "sarif-results" ]; then
          echo "Creating detailed analysis report..."
          echo "## CodeQL Security Analysis Report" > analysis-report.md
          echo "### Analysis for ${{ matrix.language }}" >> analysis-report.md
          echo "Completed at: $(date)" >> analysis-report.md
          echo "#### Findings Summary" >> analysis-report.md
          
          if [ -f sarif-results/*.sarif ]; then
            echo "- SARIF results available" >> analysis-report.md
            # Add basic statistics if possible
            ALERTS=$(grep -c "warning" sarif-results/*.sarif || echo "0")
            echo "- Number of potential issues: $ALERTS" >> analysis-report.md
          else
            echo "- No SARIF results found" >> analysis-report.md
          fi
        fi

    - name: Upload Analysis Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: codeql-analysis-${{ matrix.language }}
        path: |
          analysis-report.md
          sarif-results
        retention-days: 30

  summary:
    name: Analysis Summary
    needs: analyze
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create Summary
        run: |
          echo "# CodeQL Analysis Complete" > summary.md
          echo "## Status by Language" >> summary.md
          echo "- Python: ${{ needs.analyze.result }}" >> summary.md
          echo "- JavaScript/TypeScript: ${{ needs.analyze.result }}" >> summary.md
          echo "- Java/Kotlin: ${{ needs.analyze.result }}" >> summary.md
          echo "- C/C++: ${{ needs.analyze.result }}" >> summary.md
          echo "- Go: ${{ needs.analyze.result }}" >> summary.md
          echo "- Ruby: ${{ needs.analyze.result }}" >> summary.md
          
      - name: Upload Summary
        uses: actions/upload-artifact@v3
        with:
          name: codeql-final-summary
          path: summary.md
